# Enabling ETCD Backup CronJob to NFS

1. Prepare NFS server/export, in this example we are using below export:
```bash
# cat /etc/exports
/mnt/nfs  192.168.254.0/24(rw,sync,no_wdelay,no_root_squash,insecure)
```

2. Create PV and PVC for the cronjob backup pod.
```bash
#> oc create -f  etcdbackup-nfs-pv.yaml

#> oc create -f etcdbackup-nfs-pvc.yaml
```

3. Create configmap consists of the backup script. This will be mounted by the cronjob pod. This script is generated by the cluster-etcd-operator in the master node with some `mkdir` customization to put backup into folder with timestamp.

When update required, copy the script from master script and update this configmap.

```bash
#> oc create -f etcd-backup-script-cm.yaml
```

4. Last but not least, create a cronjob to take backup and put it into NFS share.

```bash
#> oc create -f etcbackup-cronjob.yaml
```

* **NOTE**: Make sure to update cronjob container image using correct etcd release image. This is especially after a cluster has been upgraded. To get correct container image, login to any of the master and execute below command, and replace the image name in the cronjob with the output.
```bash

[coremaster01 ~]$ cat /etc/kubernetes/manifests/etcd-pod.yaml | jq '.spec.containers[] | select(.name == "etcd").env[] | select (.name == "ETCD_IMAGE")'

{
  "name": "ETCD_IMAGE",
  "value": "quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:e547acdeb82a29ae9561b1d04b55525ec78a678d892a0575f8c8c34f93542ae7"
}

```